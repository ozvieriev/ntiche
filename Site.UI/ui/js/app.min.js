"use strict";

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

angular.module('app.components', ['ui.router', 'pascalprecht.translate']);
angular.module('app.auth', []);
angular.module('app.services', []);
angular.module('app.controllers', []);
angular.module('app.directives', []);
angular.module('app.filters', []);
angular.module('app', ['app.components', 'app.auth', 'app.services', 'app.controllers', 'app.directives', 'app.filters']).run(function ($trace, $transitions, $auth, $translate, $translatePartialLoader) {
  $trace.enable('TRANSITION');
  $transitions.onBefore({
    to: '**'
  }, function (transition) {
    var to = transition.to();
    var stateService = transition.router.stateService;
    var locale = stateService.params.locale || 'en';

    if (to.isProtected && !$auth.isAuthenticated()) {
      var params = {
        returnUrl: to.url.replace(/^\//g, ''),
        locale: locale
      };
      return transition.router.stateService.target('account/sign-in', params);
    }
  });
  $transitions.onSuccess({
    to: '**'
  }, function (transition) {
    var stateService = transition.router.stateService;
    var locale = stateService.params.locale || 'en';
    $translatePartialLoader.addPart('index');
    $translate.use(locale);
  });
}); //https://github.com/modularcode/modular-admin-angularjs/blob/master/src/_main.js

angular.module('app').config(['$httpProvider', function ($httpProvider) {
  $httpProvider.interceptors.push([function () {
    var interceptor = {};

    interceptor.response = function (response) {
      var config = response.config || {};
      if (config.asJson === true) return response.data;
      return response;
    };

    return interceptor;
  }]);
}]);
angular.module('app').config(['$translateProvider', '$translatePartialLoaderProvider', function ($translateProvider, $translatePartialLoaderProvider) {
  // // $translateProvider.useLoader('$i18nLoader', {});
  // // $translateProvider.useLocalStorage();
  $translateProvider.useLoader('$translatePartialLoader', {
    urlTemplate: 'i18n/{part}/{lang}.json'
  });
  $translateProvider.preferredLanguage('en');
  $translatePartialLoaderProvider.addPart('global/button');
}]);
angular.module('app').config(function ($stateProvider, $urlRouterProvider) {
  // $locationProvider.html5Mode({
  //     enabled: true,
  //     requireBase: false
  // });
  $urlRouterProvider.otherwise('/en/index');
  $stateProvider.state('app', {
    url: '/:locale',
    //templateUrl: 'index.html',
    restricted: false,
    abstract: true,
    views: {
      header: {
        templateUrl: 'partial/header.html',
        controller: 'partialHeaderController'
      },
      main: {
        controller: 'appController'
      },
      footer: {
        templateUrl: 'partial/footer.html'
      }
    }
  });

  var _state = function _state(json) {
    json.name = json.name || json.url;
    json.params = json.params || {};
    json.templateUrl = json.templateUrl || "views/".concat(json.url, ".html");
    json.isProtected = !!json.isProtected;
    var state = {
      parent: 'app',
      url: "/".concat(json.url),
      params: json.params,
      templateUrl: json.templateUrl,
      isProtected: json.isProtected
    };
    if (json.controller) state.controller = "".concat(json.controller, "Controller");
    $stateProvider.state(json.name, state);
  };

  _state({
    url: 'account/index',
    controller: 'accountIndex',
    isProtected: true
  });

  _state({
    url: 'account/email-confirmation',
    controller: 'accountEmailConfirmation'
  });

  _state({
    url: 'account/recover-password',
    controller: 'accountRecoverPassword'
  });

  _state({
    url: 'account/sign-in',
    controller: 'accountSignIn',
    params: {
      returnUrl: null
    }
  });

  _state({
    url: 'account/sign-up',
    controller: 'accountSignUp'
  });

  _state({
    url: 'learning/nutrition-cancer-related-fatigue',
    isProtected: true
  });

  _state({
    url: 'learning/overview',
    isProtected: true
  });

  _state({
    url: 'learning/physical-activity-cancer-related-fatigue',
    isProtected: true
  });

  _state({
    url: 'learning/psychological-wellness-cancer-related-fatigue',
    isProtected: true
  });

  _state({
    url: 'learning/sleep-cancer-related-fatigue',
    isProtected: true
  });

  _state({
    url: 'learning/spirituality-cancer-related-fatigue',
    isProtected: true
  });

  _state({
    url: 'about'
  });

  _state({
    url: 'contact-us'
  });

  _state({
    url: 'disclaimer'
  });

  _state({
    url: 'error'
  });

  _state({
    url: 'index',
    controller: 'index'
  });

  _state({
    url: 'privacy'
  });

  _state({
    url: 'resources'
  });
}); //https://github.com/modularcode/modular-admin-angularjs/blob/master/src/_main.js

angular.module('app.controllers').controller('appController', ['$scope', '$state', '$stateParams', function ($scope, $state, $stateParams) {}]);
angular.module('app.controllers').controller('indexController', ['$scope', function ($scope) {}]);
angular.module('app.auth').factory('$auth', ['$q', '$state', '$injector', '$authStorage', function ($q, $state, $injector, $authStorage) {
  var _apiHeaders = {
    'Content-Type': 'application/x-www-form-urlencoded'
  };

  var _uri = function _uri(method) {
    return "http://localhost:37321/".concat(method);
  };

  var service = {};

  service.isAuthenticated = function () {
    return !!$authStorage.getItem();
  };

  service.signIn = function (userName, password) {
    var data = {
      grant_type: 'password',
      userName: userName,
      password: password
    };
    var deferred = $q.defer();
    var $http = $injector.get("$http");
    $http.post(_uri('api/token'), $.param(data), {
      headers: _apiHeaders,
      asJson: true
    }).then(function (json) {
      $authStorage.setItem(json);
      deferred.resolve(json);
    }, function (error) {
      deferred.reject(error.data);
    });
    return deferred.promise;
  };

  service.accountGet = function (params) {
    var $http = $injector.get("$http");
    return $http.get(_uri('api/account'), {
      params: params,
      asJson: true
    });
  };

  service.emailConfirmation = function (emailConfirmationToken, accountId) {
    var data = {
      grant_type: 'password',
      emailConfirmationToken: emailConfirmationToken,
      accountId: accountId
    };
    var $http = $injector.get("$http");
    $http.post(_uri('api/token'), $.param(data), {
      headers: _apiHeaders
    });
  };

  service.recoverPassword = function (params) {
    var $http = $injector.get("$http");
    return $http.get(_uri('api/account/recover-password'), {
      params: params,
      asJson: true
    });
  };

  return service;
}]);
angular.module('app.auth').factory('$authBuffer', ['$injector', function ($injector) {
  /** Holds all the requests, so they can be re-requested in future. */
  var _buffer = [];
  /** Service initialized later because of circular dependency problem. */

  var $http;

  var _retryHttpRequest = function _retryHttpRequest(config, deferred) {
    var _success = function _success(response) {
      deferred.resolve(response);
    };

    var _error = function _error(response) {
      deferred.reject(response);
    };

    $http = $http || $injector.get('$http');
    $http(config).then(_success, _error);
  };

  var service = {};
  /**
  * Appends HTTP request configuration object with deferred response attached to buffer.
  */

  service.append = function (config, deferred) {
    _buffer.push({
      config: config,
      deferred: deferred
    });
  };
  /**
  * Abandon or reject (if reason provided) all the buffered requests.
  */


  service.rejectAll = function (reason) {
    if (reason) {
      for (var index = 0; index < _buffer.length; ++index) {
        _buffer[index].deferred.reject(reason);
      }
    }

    _buffer = [];
  };
  /**
   * Retries all the buffered requests clears the buffer.
   */


  service.retryAll = function (updater) {
    for (var index = 0; index < _buffer.length; ++index) {
      _retryHttpRequest(updater(_buffer[index].config), _buffer[index].deferred);
    }

    _buffer = [];
  };

  return service;
}]);
angular.module('app.auth').config(['$httpProvider', function ($httpProvider) {
  $httpProvider.interceptors.push(['$q', '$auth', '$authInterceptor', '$authBuffer', function ($q, $auth, $authInterceptor, $authBuffer) {
    var interceptor = {};

    interceptor.request = function (config) {
      config.headers = config.headers || {}; //   if ($auth.isAuthenticated())
      //       config.headers.Authorization = 'bearer ' + $auth.getAccessToken();

      return config;
    };

    interceptor.responseError = function (rejection) {
      var config = rejection.config || {};

      switch (rejection.status) {
        case 401:
          var deferred = $q.defer();
          $authBuffer.append(config, deferred);
          $auth.refreshToken().then($authInterceptor.loginConfirmed, $auth.logout);
          return deferred.promise;
      }

      return $q.reject(rejection);
    };

    return interceptor;
  }]);
}]);
angular.module('app.auth').factory('$authInterceptor', ['$authBuffer', function ($authBuffer) {
  var service = {};
  /**
  * Call this function to indicate that authentication was successfull and trigger a
  * retry of all deferred requests.
  * @param data an optional argument to pass on to $broadcast which may be useful for
  * example if you need to pass through details of the user that was logged in
  * @param configUpdater an optional transformation function that can modify the
  * requests that are retried after having logged in.  This can be used for example
  * to add an authentication token.  It must return the request.
  */

  service.loginConfirmed = function (data, configUpdater) {
    var updater = configUpdater || function (config) {
      return config;
    };

    $authBuffer.retryAll(updater);
  };
  /**
   * Call this function to indicate that authentication should not proceed.
   * All deferred requests will be abandoned or rejected (if reason is provided).
   * @param data an optional argument to pass on to $broadcast.
   * @param reason if provided, the requests are rejected; abandoned otherwise.
   */


  service.loginCancelled = function (data, reason) {
    $authBuffer.rejectAll(reason);
  };

  return service;
}]);
angular.module('app.auth').factory('$authStorage', ['$window', function ($window) {
  var _localStorage = {};

  var _getItem = function _getItem(key) {
    var json = _localStorage[key];
    var value = json ? JSON.parse(json) : null;
    _localStorage[key] = json;

    try {
      json = $window.localStorage.getItem(key);
      json && (value = JSON.parse(json));
    } catch (error) {
      console.error(error);
    }

    return value;
  };

  var _setItem = function _setItem(key, value) {
    var json = JSON.stringify(value);
    _localStorage[key] = json;

    try {
      $window.localStorage.setItem(key, json);
    } catch (error) {
      console.error(error);
    }
  };

  var _removeItem = function _removeItem(key) {
    delete _localStorage[key];

    try {
      $window.localStorage.removeItem(key);
    } catch (error) {
      console.error(error);
    }
  };

  var service = {};

  service.getItem = function () {
    return _getItem('auth');
  };

  service.setItem = function (json) {
    _setItem('auth', json);
  };

  service.removeItem = function () {
    _removeItem('auth');
  };

  return service;
}]);
angular.module('app.directives').directive('ngBraille', ['$window', function ($window) {
  var template = ['<ul class="navbar-nav">', '<li class="nav-item active" data-rem="1.0"><a class="nav-link">A</a></li>', '<li class="nav-item" data-rem="1.2"><a class="nav-link">A</a></li>', '<li class="nav-item" data-rem="1.5"><a class="nav-link">A</a></li>', '</ul>'].join('');
  return {
    restrict: 'E',
    replace: true,
    template: template,
    link: function link(scope, element, attrs) {
      var liCollection = element.find('li[data-rem]');
      liCollection.each(function (index, value) {
        var li = angular.element(value);
        var rem = li.attr('data-rem');
        li.css({
          'font-size': "".concat(rem, "rem"),
          'line-height': '1.7rem',
          cursor: 'pointer'
        });
        li.find('a').bind('click', function () {
          liCollection.removeClass('active');
          liCollection.eq(index).addClass('active');
          angular.element('body').css({
            'font-size': "".concat(rem, "rem")
          });
        });
      }); // element.find('a').bind('click', function () {
      //     var index = $(this).index();
      //     debugger
      //     $('body').css({ 'font-size': '1.2rem' });
      // });
    }
  };
}]);
angular.module('app.directives').directive('ngDate', ['$filter', function ($filter) {
  return {
    restrict: 'A',
    scope: {
      date: '=ngDate',
      format: '=ngFormat'
    },
    link: function link(scope, element, attrs) {
      if (!scope.date) return;
      element.addClass('text-muted small');
      var format = scope.format || 'yyyy-MM-dd HH:mm';
      scope.$watch('date', function (newValue, oldValue) {
        if (newValue || newValue != oldValue) element.html("<em>" + $filter('date')(scope.date, format) + "</em>");
      });
    }
  };
}]);
angular.module('app.directives').directive('ngLoadingForm', ['$window', function ($window) {
  return {
    restrict: 'A',
    scope: {},
    link: function link(scope, element, attrs) {
      var $submit = element.find('[type="submit"]');
      $submit.addClass('btn btn-primary');
      var watcher = scope.$watch('$parent.isBusy', function (isBusy) {
        isBusy ? $submit.addClass('btn-light') : $submit.removeClass('btn-light');
      });
      scope.$on('$destroy', watcher);
    }
  };
}]);
angular.module('app.services').factory('$api', ['$http', function factory($http) {
  var service = {};
  return service;
}]);
angular.module('app.services').factory('$form', function () {
  var service = {};

  service.submit = function (entity, form, callback) {
    if (form.$valid !== true) {
      angular.forEach(form, function (value, key) {
        if (_typeof(value) === 'object' && value.hasOwnProperty('$modelValue')) value.$setDirty();
      });
    }

    if (service.isReady(entity, form) === false) return;
    callback(form);
  };

  service.isReady = function (entity, form) {
    if (entity.isBusy === true || form.$valid !== true) return false;
    entity.isBusy = true;
    return true;
  };

  return service;
});
angular.module('app.services').factory('$utils', function () {
  var service = {};

  service.query = function (query) {
    var json = {};

    try {
      if (typeof query === 'undefined') query = document.location.search;
      var split = query.replace(/(^\?)/, '').split('&');

      for (var i = 0; i < split.length; ++i) {
        var item = split[i];
        var index = item.indexOf('=');
        if (index === -1) continue;
        var key = item.substring(0, index);
        var value = item.substr(index + 1).trim();
        json[key.toLowerCase()] = decodeURIComponent(value);
      }
    } catch (e) {}

    return json;
  };

  return service;
});
angular.module('app.controllers').controller('accountEmailConfirmationController', ['$scope', '$auth', '$utils', function ($scope, $auth, $utils) {
  $scope.status = null;
  $scope.isBusy = false;
  var query = $utils.query();
  if (!query.accountid || !query.emailconfirmationtoken) return $scope.status = 404;
  debugger;
  $auth.emailConfirmation(query.emailconfirmationtoken, query.accountid);
}]);
angular.module('app.controllers').controller('accountIndexController', ['$scope', function ($scope) {}]);
angular.module('app.controllers').controller('accountRecoverPasswordController', ['$scope', '$state', '$form', '$auth', function ($scope, $state, $form, $auth) {
  $scope.model = {};
  $scope.status = null;
  $scope.isBusy = false;

  $scope.submit = function (form) {
    $scope.status = null;
    $form.submit($scope, form, function () {
      return $auth.recoverPassword({
        email: $scope.model.email
      }).then(function () {
        $scope.status = 200;
      }, function (error) {
        $scope.status = error.status;
        if (error.status !== 404) return $state.go('error');
      }).finally(function () {
        $scope.isBusy = false;
      });
    });
  };
}]);
angular.module('app.controllers').controller('accountSignInController', ['$scope', '$state', '$form', '$auth', function ($scope, $state, $form, $auth) {
  $scope.model = {
    error: null
  };
  $scope.status = null;
  $scope.isBusy = false;

  $scope.submit = function (form) {
    $scope.model.error = null;
    $form.submit($scope, form, function () {
      return $auth.signIn($scope.model.userName, $scope.model.password).then(function () {
        if ($state.params.returnUrl) $state.go($state.params.returnUrl);else $state.go('account/index');
      }, function (json) {
        $scope.model.error = json.error_description;
      }).finally(function () {
        $scope.isBusy = false;
      });
    });
  };
}]);
angular.module('app.controllers').controller('accountSignUpController', ['$scope', '$auth', function ($scope, $auth) {
  $auth.accountGet({
    email: 'ozvieriev@gmail.com'
  }).then(function (response) {
    return {
      isEmailExists: true
    };
  }, function (error) {
    return $auth.accountGet({
      userName: 'MegaZver22'
    }).then(function () {
      return {
        isUserNameExists: true
      };
    }, function () {
      return {};
    });
  }).then(function (response) {
    if (response.isEmailExists) {//show error notification   
      //$scope.error = 'User with email address already exists';
    }

    if (response.isUserNameExists) {//show error notification
      //$scope.error = 'User with user name already exists';
    }
  });
}]);
angular.module('app.controllers').controller('partialHeaderController', ['$scope', '$state', function ($scope, $state) {
  $scope.changeLanguage = function (lang) {
    var url = $state.current.url.replace(/^\//g, '');
    var params = angular.copy($state.params);
    params.locale = lang;
    $state.go(url, params);
  };
}]);